<div class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-green-50 py-10 px-4 flex justify-center">
  <div class="max-w-3xl w-full bg-white rounded-2xl shadow-lg border-t-4 border-orange-500 p-6">

    <!-- Titre principal -->
    <h2
      class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-orange-500 via-white to-green-500 bg-clip-text text-transparent uppercase">
      {{ isEditMode ? 'Modifier l\'annonce' : 'Cr√©er une nouvelle annonce' }}
    </h2>

    <!-- Messages d'alerte -->
    @if (errorMessage) {
      <div class="mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg flex items-center gap-2">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ errorMessage }}</span>
      </div>
    }

    @if (successMessage) {
      <div class="mb-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg flex items-center gap-2">
        <i class="pi pi-check-circle"></i>
        <span>{{ successMessage }}</span>
      </div>
    }

    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-6">

      <!-- Titre -->
      <div>
        <label class="block font-semibold mb-1 text-gray-700">
          Titre *
          <span class="text-sm font-normal text-gray-500 ml-2">(5-200 caract√®res)</span>
        </label>
        <input
          formControlName="title"
          type="text"
          maxlength="200"
          class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50/20"
          [class.border-red-500]="isFieldInvalid('title')"
        />
        @if (getFieldError('title')) {
          <small class="text-red-500 mt-1 block">{{ getFieldError('title') }}</small>
        }
      </div>

      <!-- Description -->
      <div>
        <label class="block font-semibold mb-1 text-gray-700">
          Description *
          <span class="text-sm font-normal text-gray-500 ml-2">(minimum 20 caract√®res)</span>
        </label>
        <textarea
          formControlName="description"
          rows="5"
          class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-green-50/20"
          [class.border-red-500]="isFieldInvalid('description')"
        ></textarea>
        @if (getFieldError('description')) {
          <small class="text-red-500 mt-1 block">{{ getFieldError('description') }}</small>
        }
      </div>

      <!-- Prix et n√©gociable -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <label class="block font-semibold mb-1 text-gray-700">Prix (FCFA) *</label>
          <input
            formControlName="price"
            type="number"
            min="0"
            step="100"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50/20"
            [class.border-red-500]="isFieldInvalid('price')"
          />
          @if (getFieldError('price')) {
            <small class="text-red-500 mt-1 block">{{ getFieldError('price') }}</small>
          }
        </div>
        <div class="flex items-center mt-1 sm:mt-7">
          <input formControlName="is_negotiable" type="checkbox" id="negotiable" class="mr-2 w-4 h-4 accent-green-500" />
          <label for="negotiable" class="font-medium text-gray-700">N√©gociable</label>
        </div>
      </div>

      <!-- Cat√©gorie et ville -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <label class="block font-semibold mb-1 text-gray-700">Cat√©gorie *</label>
          <select
            formControlName="category"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-green-50/20"
            [class.border-red-500]="isFieldInvalid('category')"
          >
            <option value="">-- S√©lectionner --</option>
            <option *ngFor="let cat of categories" [value]="cat.value">{{ cat.label }}</option>
          </select>
          @if (getFieldError('category')) {
            <small class="text-red-500 mt-1 block">{{ getFieldError('category') }}</small>
          }
        </div>
        <div class="flex-1">
          <label class="block font-semibold mb-1 text-gray-700">Ville *</label>
          <select
            formControlName="city"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50/20"
            [class.border-red-500]="isFieldInvalid('city')"
          >
            <option value="">-- S√©lectionner --</option>
            <option *ngFor="let c of cities" [value]="c.value">{{ c.label }}</option>
          </select>
          @if (getFieldError('city')) {
            <small class="text-red-500 mt-1 block">{{ getFieldError('city') }}</small>
          }
        </div>
      </div>

      <!-- Contact (optionnel) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold mb-1 text-gray-700">
            T√©l√©phone <span class="text-sm font-normal text-gray-500">(optionnel)</span>
          </label>
          <input
            formControlName="contact_phone"
            type="tel"
            placeholder="+225 XX XX XX XX XX"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-orange-50/20"
          />
        </div>
        <div>
          <label class="block font-semibold mb-1 text-gray-700">
            WhatsApp <span class="text-sm font-normal text-gray-500">(optionnel)</span>
          </label>
          <input
            formControlName="whatsapp_number"
            type="tel"
            placeholder="+225 XX XX XX XX XX"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-green-50/20"
          />
        </div>
      </div>

      <!-- Date d'expiration et urgent -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <label class="block font-semibold mb-1 text-gray-700">Date d'expiration *</label>
          <input
            formControlName="expires_at"
            type="date"
            [min]="today()"
            class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white text-gray-900"
            [class.border-red-500]="isFieldInvalid('expires_at')"
          />
          @if (getFieldError('expires_at')) {
            <small class="text-red-500 mt-1 block">{{ getFieldError('expires_at') }}</small>
          }
        </div>
        <div class="flex items-center mt-1 sm:mt-7">
          <input formControlName="is_urgent" type="checkbox" id="urgent" class="mr-2 w-4 h-4 accent-orange-500" />
          <label for="urgent" class="font-medium text-gray-700">
            Annonce urgente <span class="text-orange-500">üî•</span>
          </label>
        </div>
      </div>

      <!-- Images (1 minimum, 3 maximum) -->
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
        <label class="block font-semibold mb-3 text-gray-700">
          Images *
          <span class="text-sm font-normal text-gray-500 ml-2">
            ({{ MIN_IMAGES }} minimum, {{ MAX_IMAGES }} maximum - Taille max: 5Mo par image)
          </span>
        </label>

        <!-- Compteur d'images -->
        <div class="mb-3 text-center">
          <span class="text-lg font-semibold" [class.text-red-500]="imagePreviews.length < MIN_IMAGES"
                [class.text-green-600]="imagePreviews.length >= MIN_IMAGES">
            {{ imagePreviews.length }} / {{ MAX_IMAGES }} images
          </span>
          @if (imagePreviews.length < MIN_IMAGES) {
            <span class="text-red-500 text-sm block">
              ‚ö†Ô∏è Ajoutez au moins {{ MIN_IMAGES - imagePreviews.length }} image(s) suppl√©mentaire(s)
            </span>
          }
          @if (canAddImages()) {
            <span class="text-gray-600 text-sm block">
              Vous pouvez ajouter encore {{ getRemainingImagesCount() }} image(s)
            </span>
          }
        </div>

        <!-- Boutons d'ajout -->
        <div class="flex flex-wrap gap-3 mb-4 justify-center">
          <!-- Galerie -->
          <label
            class="cursor-pointer bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-medium py-3 px-6 rounded-lg shadow-md transition-all transform hover:-translate-y-0.5"
            [class.opacity-50]="!canAddImages()"
            [class.cursor-not-allowed]="!canAddImages()"
          >
            <i class="pi pi-images mr-2"></i>
            Choisir depuis la galerie
            <input
              type="file"
              accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
              multiple
              (change)="onImagesSelected($event)"
              [disabled]="!canAddImages()"
              class="hidden"
            />
          </label>

          <!-- Cam√©ra -->
          <label
            class="cursor-pointer bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-3 px-6 rounded-lg shadow-md transition-all transform hover:-translate-y-0.5"
            [class.opacity-50]="!canAddImages()"
            [class.cursor-not-allowed]="!canAddImages()"
          >
            <i class="pi pi-camera mr-2"></i>
            Prendre une photo
            <input
              type="file"
              accept="image/*"
              capture="environment"
              (change)="onImagesSelected($event)"
              [disabled]="!canAddImages()"
              class="hidden"
            />
          </label>
        </div>

        <!-- Formats accept√©s -->
        <p class="text-xs text-gray-500 text-center mb-4">
          Formats accept√©s : JPG, JPEG, PNG, GIF, WEBP
        </p>

        <!-- Aper√ßu des images -->
        @if (imagePreviews.length > 0) {
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div
              *ngFor="let img of imagePreviews; let i = index"
              class="relative group"
            >
              <img
                [src]="img.url"
                [alt]="'Image ' + (i + 1)"
                class="w-full h-40 object-cover rounded-lg shadow-md transition-transform group-hover:scale-105"
                [class.border-4]="i === 0"
                [class.border-orange-500]="i === 0"
              />

              <!-- Badge image primaire -->
              @if (i === 0) {
                <div class="absolute top-2 left-2 bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded">
                  <i class="pi pi-star mr-1"></i>
                  PRINCIPALE
                </div>
              }

              <!-- Ordre -->
              <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs font-bold px-2 py-1 rounded-full">
                {{ i + 1 }}
              </div>

              <!-- Actions -->
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="flex justify-between">
                  @if (i !== 0) {
                    <button
                      type="button"
                      (click)="setPrimaryImage(i)"
                      class="bg-orange-500 hover:bg-orange-600 text-white text-xs px-2 py-1 rounded"
                      title="D√©finir comme image principale"
                    >
                      <i class="pi pi-star"></i>
                    </button>
                  }

                  <button
                    type="button"
                    (click)="removeImage(i)"
                    class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded ml-auto"
                    [disabled]="imagePreviews.length <= MIN_IMAGES"
                    [class.opacity-50]="imagePreviews.length <= MIN_IMAGES"
                    [class.cursor-not-allowed]="imagePreviews.length <= MIN_IMAGES"
                    title="Supprimer l'image"
                  >
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <p class="text-sm text-gray-600 mt-3 text-center">
            <i class="pi pi-info-circle mr-1"></i>
            La premi√®re image sera l'image principale de votre annonce
          </p>
        }
      </div>

      <!-- Submit -->
      <div class="text-center pt-4">
        <button
          type="submit"
          [disabled]="loading || imagePreviews.length < MIN_IMAGES"
          class="w-full md:w-auto bg-gradient-to-r from-orange-500 to-green-500 text-black font-semibold rounded-full py-4 px-12 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        >
          @if (loading) {
            <i class="pi pi-spin pi-spinner mr-2"></i>
            Enregistrement en cours...
          } @else if (isEditMode) {
            <i class="pi pi-save mr-2"></i>
            Enregistrer les modifications
          } @else {
            <i class="pi pi-check-circle mr-2"></i>
            Publier l'annonce
          }
        </button>

        @if (imagePreviews.length < MIN_IMAGES) {
          <p class="text-red-500 text-sm mt-2">
            ‚ö†Ô∏è Ajoutez au moins {{ MIN_IMAGES }} image pour publier
          </p>
        }
      </div>
    </form>
  </div>
</div>
